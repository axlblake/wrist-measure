<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hand Measurement Wizard (Stable)</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js" crossorigin="anonymous"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f9; margin:0; display:flex; justify-content:center; align-items:center; min-height:100vh; }
    #app { width:820px; background:white; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,0.1); padding:20px 40px; }
    h2 { text-align:center; }
    .step { display:none; }
    .active { display:block; }
    .nav { text-align:center; margin-top:20px; }
    button { padding:10px 20px; margin:5px; border:none; border-radius:5px; cursor:pointer; }
    button.primary { background:#007bff; color:white; }
    button.secondary { background:#6c757d; color:white; }
    .video-container { position:relative; width:640px; height:480px; margin:0 auto; }
    video, canvas { position:absolute; top:0; left:0; }
    pre { background:#f1f1f1; padding:10px; border-radius:5px; overflow-x:auto; }
  </style>
</head>
<body>
<div id="app">
  <h2>Hand Measurement Wizard</h2>

  <!-- Step 1 -->
  <div class="step active" id="step1">
    <p>Welcome! Place your hand flat in front of the camera with a reference card.</p>
    <div class="nav">
      <button class="primary" onclick="nextStep(2)">Start</button>
    </div>
  </div>

  <!-- Step 2 -->
  <div class="step" id="step2">
    <div class="video-container">
      <video id="video" autoplay muted playsinline width="640" height="480"></video>
      <canvas id="canvas" width="640" height="480"></canvas>
    </div>
    <div class="nav">
      <button class="secondary" onclick="nextStep(1)">Back</button>
      <button class="primary" onclick="capture()">Capture</button>
    </div>
  </div>

  <!-- Step 3 -->
  <div class="step" id="step3">
    <p>Measurements:</p>
    <pre id="markdown"></pre>
    <div class="nav">
      <button class="secondary" onclick="nextStep(2)">Back</button>
      <button class="primary" onclick="download()">Download</button>
    </div>
  </div>
</div>

<script>
let handLandmarker, drawingUtils, latestLandmarks=null;

function nextStep(n){
  document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
  document.getElementById('step'+n).classList.add('active');
  if(n===2) startCamera();
}

async function init(){
  const vision = await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/wasm"
  );
  handLandmarker = await HandLandmarker.createFromOptions(vision, {
    baseOptions: { modelAssetPath: "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/hand_landmarker.task" },
    runningMode: "VIDEO", numHands: 1
  });
  drawingUtils = new DrawingUtils(document.getElementById("canvas").getContext("2d"));
}
init();

const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

async function startCamera(){
  const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  video.srcObject=stream;
  video.onloadedmetadata=()=>{ video.play(); requestAnimationFrame(loop); };
}

async function loop(){
  if(video.readyState===4 && handLandmarker){
    const now=performance.now();
    const result=await handLandmarker.detectForVideo(video,now);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    if(result.landmarks){
      latestLandmarks=result.landmarks[0];
      drawingUtils.drawLandmarks(latestLandmarks,{color:"red",radius:3});
      drawingUtils.drawConnectors(latestLandmarks, HandLandmarker.HAND_CONNECTIONS,{color:"lime",lineWidth:2});
    }
  }
  requestAnimationFrame(loop);
}

function capture(){
  if(!latestLandmarks){ alert("No hand detected!"); return; }
  const fingers={Thumb:[1,2,3,4],Index:[5,6,7,8],Middle:[9,10,11,12],Ring:[13,14,15,16],Little:[17,18,19,20]};
  let md="# Hand Measurements (pixel units)\n\n";
  for(let [name,ids] of Object.entries(fingers)){
    let len=0;
    for(let i=0;i<ids.length-1;i++) len+=dist(latestLandmarks[ids[i]],latestLandmarks[ids[i+1]]);
    md+=`- ${name}: ${len.toFixed(1)} px\n`;
  }
  document.getElementById("markdown").textContent=md;
  nextStep(3);
}

function dist(a,b){
  const dx=a.x-b.x, dy=a.y-b.y; return Math.sqrt(dx*dx+dy*dy);
}

function download(){
  const text=document.getElementById("markdown").textContent;
  const blob=new Blob([text],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob); a.download="hand_measurements.md"; a.click();
}
</script>
</body>
</html>
