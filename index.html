<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HandLandmarker — MediaPipe Tasks Vision</title>
  <style>
    body { display:flex; flex-direction:column; align-items:center; margin:0; background:#f4f6f9; }
    video, canvas { border:1px solid #ccc; }
    #log {
      margin-top:10px;
      white-space:pre-wrap;
      font-size:14px;
      background:#111;
      color:#0f0;
      padding:10px;
      width:90%;
      max-width:640px;
      height:150px;
      overflow:auto;
      border-radius:6px;
    }
    button { margin:10px; padding:10px 20px; font-size:16px; }
  </style>
</head>
<body>
  <h3>HandLandmarker (Tasks Vision)</h3>
  <button id="switchBtn">Switch Camera</button>
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>
  <div id="log">Logs will appear here...</div>

<script type="module">
  import { HandLandmarker, FilesetResolver, DrawingUtils } 
    from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.mjs";

  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const logBox = document.getElementById("log");
  function log(msg){ logBox.textContent+=msg+"\n"; logBox.scrollTop=logBox.scrollHeight; }

  let handLandmarker = null;
  let useUserCamera = true;
  let drawingUtils = null;

  async function init(){
    log("Loading HandLandmarker...");
    try {
      const vision = await FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
      );

      handLandmarker = await HandLandmarker.createFromOptions(vision, {
        baseOptions: {
          modelAssetPath: "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/hand_landmarker.task"
        },
        runningMode: "VIDEO",
        numHands: 1
      });

      drawingUtils = new DrawingUtils(ctx);

      log("HandLandmarker ready ✅");
      startCamera();
    } catch (e) {
      log("Init error: "+e);
    }
  }

  async function startCamera(){
    try {
      const facing = useUserCamera ? "user" : "environment";
      const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:facing}});
      video.srcObject = stream;
      video.onloadedmetadata = () => {
        video.play();
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        log("Camera started at "+video.videoWidth+"x"+video.videoHeight);
        requestAnimationFrame(loop);
      };
    } catch (e) {
      log("Camera error: "+e);
    }
  }

  document.getElementById("switchBtn").onclick = () => {
    useUserCamera = !useUserCamera;
    startCamera();
  };

  async function loop(){
    if(video.readyState === 4 && handLandmarker){
      const now = performance.now();
      const result = await handLandmarker.detectForVideo(video, now);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      if(result.landmarks && result.landmarks.length>0){
        log("Detected "+result.landmarks.length+" hand(s)");
        for(const lm of result.landmarks){
          // draw connectors + landmarks
          drawingUtils.drawLandmarks(lm, {color:"red", radius:4});
          drawingUtils.drawConnectors(lm, HandLandmarker.HAND_CONNECTIONS, {color:"lime", lineWidth:2});
        }
      } else {
        log("No hands detected ❌");
      }
    }
    requestAnimationFrame(loop);
  }

  init();
</script>
</body>
</html>
