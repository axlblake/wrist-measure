<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HandLandmarker Debug</title>
  <style>
    body { display:flex; flex-direction:column; align-items:center; margin:0; background:#f4f6f9; }
    video, canvas { border:1px solid #ccc; max-width:95vw; height:auto; }
    #log {
      margin-top:10px;
      white-space:pre-wrap;
      font-size:14px;
      background:#111;
      color:#0f0;
      padding:10px;
      width:90%;
      max-width:640px;
      height:200px;
      overflow:auto;
      border-radius:6px;
    }
  </style>
</head>
<body>
  <h3>HandLandmarker Debug</h3>
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>
  <div id="log">Logs will appear here...</div>

<script type="module">
  import { HandLandmarker, FilesetResolver, DrawingUtils }
    from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.mjs";

  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const logBox = document.getElementById("log");
  function log(msg){ logBox.textContent+=msg+"\n"; logBox.scrollTop=logBox.scrollHeight; }

  let handLandmarker=null;
  let drawingUtils=null;

  async function init(){
    log("Loading HandLandmarker...");
    try {
      const vision = await FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
      );

      handLandmarker = await HandLandmarker.createFromOptions(vision, {
        baseOptions: {
          modelAssetPath: "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/hand_landmarker.task"
        },
        runningMode: "VIDEO",
        numHands: 1
      });

      drawingUtils = new DrawingUtils(ctx);
      log("HandLandmarker ready ✅");
      startCamera();
    } catch (e) {
      log("Init error: "+e);
    }
  }

  async function startCamera(){
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width:640, height:480 }});
      video.srcObject = stream;
      video.onloadedmetadata = () => {
        video.play();
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        log("Camera started at "+video.videoWidth+"x"+video.videoHeight);
        requestAnimationFrame(loop);
      };
    } catch (e) {
      log("Camera error: "+e);
    }
  }

  async function loop(){
    if(video.readyState === 4 && handLandmarker){
      const now = performance.now();
      let result;
      try {
        result = await handLandmarker.detectForVideo(video, now);
      } catch (e) {
        log("detectForVideo error: "+e);
        return requestAnimationFrame(loop);
      }

      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(video,0,0,canvas.width,canvas.height);

      if(result && result.landmarks && result.landmarks.length>0){
        log("Detected "+result.landmarks.length+" hand(s) at "+Math.round(now)+"ms");
        for(const lm of result.landmarks){
          drawingUtils.drawLandmarks(lm,{color:"red",radius:4});
          drawingUtils.drawConnectors(lm, HandLandmarker.HAND_CONNECTIONS,{color:"lime",lineWidth:2});
        }
      } else {
        log("No hands detected ❌ at "+Math.round(now)+"ms");
      }
    }
    requestAnimationFrame(loop);
  }

  init();
</script>
</body>
</html>
