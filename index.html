<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HandLandmarker Demo (Correct Globals)</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js"></script>
  <style>
    body { display:flex; flex-direction:column; align-items:center; margin:0; background:#f4f6f9; }
    video, canvas { border:1px solid #ccc; }
    #log {
      margin-top:10px;
      white-space:pre-wrap;
      font-size:14px;
      background:#111;
      color:#0f0;
      padding:10px;
      width:90%;
      max-width:640px;
      height:150px;
      overflow:auto;
      border-radius:6px;
    }
    button { margin:10px; padding:10px 20px; font-size:16px; }
  </style>
</head>
<body>
  <h3>HandLandmarker (MediaPipe Tasks Vision)</h3>
  <button onclick="switchCamera()">Switch Camera</button>
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>
  <div id="log">Logs will appear here...</div>

<script>
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const logBox=document.getElementById("log");

function log(msg){ logBox.textContent+=msg+"\n"; logBox.scrollTop=logBox.scrollHeight; }

let handLandmarker=null;
let useUserCamera=true;

async function init(){
  log("Loading HandLandmarker...");
  try {
    const visionFiles = await vision.FilesetResolver.forVisionTasks(
      "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/wasm"
    );

    handLandmarker = await vision.HandLandmarker.createFromOptions(visionFiles, {
      baseOptions: {
        modelAssetPath: "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/hand_landmarker.task"
      },
      runningMode: "VIDEO",
      numHands: 1
    });

    log("HandLandmarker ready ✅");
    startCamera();
  } catch (e) {
    log("Init error: "+e);
  }
}

async function startCamera(){
  try {
    const facing=useUserCamera ? "user" : "environment";
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:facing}});
    video.srcObject=stream;
    video.onloadedmetadata=()=>{
      video.play();
      canvas.width=video.videoWidth;
      canvas.height=video.videoHeight;
      log("Camera started at "+video.videoWidth+"x"+video.videoHeight);
      requestAnimationFrame(loop);
    };
  } catch (e) {
    log("Camera error: "+e);
  }
}

function switchCamera(){
  useUserCamera=!useUserCamera;
  startCamera();
}

async function loop(){
  if(video.readyState===4 && handLandmarker){
    const now=performance.now();
    const result=await handLandmarker.detectForVideo(video, now);
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    if(result.landmarks && result.landmarks.length>0){
      log("Detected "+result.landmarks.length+" hand(s)");
      for(const lm of result.landmarks){
        drawLandmarks(lm);
      }
    } else {
      log("No hands detected ❌");
    }
  }
  requestAnimationFrame(loop);
}

function drawLandmarks(landmarks){
  ctx.fillStyle="red";
  for(const pt of landmarks){
    ctx.beginPath();
    ctx.arc(pt.x*canvas.width, pt.y*canvas.height, 4, 0, 2*Math.PI);
    ctx.fill();
  }
}

init();
</script>
</body>
</html>
